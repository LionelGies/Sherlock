<script type="text/javascript">
window.tinyMCECustomInit = function(ed) {
  var dropdown = ed.controlManager.get('snippetDropdown');
  <% @text_snippets.each do |snippet| %>
      dropdown.add('<%= escape_javascript(snippet.title) %>', '<%= snippet.id %>');
  <% end %>
                        
  var caseID = 0;
            
  function processKeyDown(inst, e)        
  {
    var result = true;
    
    var code = 0;    
    // Firefox uses the e.which event for keypress
    // While IE and others use e.keyCode, so we look for both
    if (e.keyCode) code = e.keyCode;
    else if (e.which) code = e.which;
    
    if (code == 9 && !e.altKey && !e.ctrlKey) {
      // toggle between Indent and Outdent command, depending on if SHIFT is pressed
      //if (e.shiftKey) inst.execCommand('Outdent');
      //else inst.execCommand('Indent');
      
      var tab = "&nbsp;&nbsp;&nbsp;&nbsp;";
      tab += tab;
      inst.execCommand('mceInsertContent', false, tab);
      
      // prevent tab key from leaving editor in some browsers
      if (e.preventDefault) {
        e.preventDefault();
      }
      result = false;
    }
    return result;
  }
  
  function processKeyDownAndAutoSave(inst, e)
  {
    var result = processKeyDown(inst, e);
    SHERLOCK.utils.richEditorContentChanged(inst, caseID);
    return result;
  }
  
  // fix the tab behavior
  // we add autosave on top of it - only for selected pages
          
  var m = location.href.match(/cases\/(\d+)\/edit/)
  if (m && m.length > 1) {
    caseID = m[1];
    ed.onKeyDown.add(processKeyDownAndAutoSave);
  } else {
    ed.onKeyDown.add(processKeyDown);
  }  
  
  
        
}
</script>